{"dependencies":[{"name":"@fortawesome/fontawesome-free/js/all","loc":{"line":1,"column":7}},{"name":"ol/ol.css","loc":{"line":3,"column":7}},{"name":"ol/Map","loc":{"line":4,"column":16}},{"name":"ol/View","loc":{"line":5,"column":17}},{"name":"ol/proj","loc":{"line":6,"column":36}},{"name":"ol/layer","loc":{"line":7,"column":53}},{"name":"ol/source","loc":{"line":8,"column":51}},{"name":"axios","loc":{"line":10,"column":18}},{"name":"nouislider/distribute/nouislider.min.css","loc":{"line":12,"column":7}},{"name":"nouislider","loc":{"line":13,"column":23}},{"name":"moment","loc":{"line":14,"column":19}}],"generated":{"js":"\"use strict\";\n\nrequire(\"@fortawesome/fontawesome-free/js/all\");\n\nrequire(\"ol/ol.css\");\n\nvar _Map = require(\"ol/Map\");\n\nvar _Map2 = _interopRequireDefault(_Map);\n\nvar _View = require(\"ol/View\");\n\nvar _View2 = _interopRequireDefault(_View);\n\nvar _proj = require(\"ol/proj\");\n\nvar _layer = require(\"ol/layer\");\n\nvar _source = require(\"ol/source\");\n\nvar _axios = require(\"axios\");\n\nvar _axios2 = _interopRequireDefault(_axios);\n\nrequire(\"nouislider/distribute/nouislider.min.css\");\n\nvar _nouislider = require(\"nouislider\");\n\nvar _nouislider2 = _interopRequireDefault(_nouislider);\n\nvar _moment = require(\"moment\");\n\nvar _moment2 = _interopRequireDefault(_moment);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nconst lstd_url = \"https://webgis.izs.it/arcgis/rest/services/Modis/MOD11C3_0_LSTD/ImageServer\";\nconst lstn_url = \"https://webgis.izs.it/arcgis/rest/services/Modis/MOD11C3_5_LSTN/ImageServer\";\nconst ndvi_url = \"https://webgis.izs.it/arcgis/rest/services/Modis/MOD13C2_0_NDVI/ImageServer\";\nconst evi_url = \"https://webgis.izs.it/arcgis/rest/services/Modis/MOD13C2_1_EVI/ImageServer\";\n\n// *******************************************\n// Map\n// *******************************************\nvar map = new _Map2.default({\n  target: 'map',\n  layers: [new _layer.Tile({\n    source: new _source.OSM()\n  })],\n  view: new _View2.default({\n    center: (0, _proj.fromLonLat)([14, 42]),\n    zoom: 5\n  })\n});\n\nmap.on('click', function (evt) {\n  requestModisValues(evt.coordinate);\n});\n\n// *******************************************\n// MODIS Layer\n// *******************************************\nvar modisSource = new _source.ImageArcGISRest({\n  ratio: 1,\n  params: {\n    TIME: \"1420066800000,1422745200000\"\n  },\n  url: lstd_url\n});\n\nvar modisLayer = new _layer.Image({\n  source: modisSource\n});\n\nmodisSource.on('imageloadstart', function () {\n  // console.log('Inizio caricamento')\n  document.querySelector('#loading-div').innerHTML = '<br/><i class=\"fas fa-spinner fa-spin\"></i> Loading MODIS data';\n});\n\nmodisSource.on('imageloadend', function () {\n  // console.log('Fine caricamento')\n  document.querySelector('#loading-div').innerHTML = \"\";\n});\n\nmap.addLayer(modisLayer);\n\n// *******************************************\n// Date slider control\n// *******************************************\nfunction timestampStr(str) {\n  return new Date(str).getTime();\n}\n\nvar slider = document.querySelector('#slider');\n\n_nouislider2.default.create(slider, {\n  start: 0,\n  step: 1,\n  connect: true,\n  range: {\n    min: 0,\n    max: 11\n  }\n});\n\nvar month = document.querySelector(\"#month\");\nvar timestamp = document.querySelector(\"#timestamp\");\nconst range = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];\n\nconst updateTimeFilter = function (timestr) {\n  let starttime = timestr;\n  let endtime = (0, _moment2.default)(new Date(timestr)).add(1, 'month');\n  // console.log(starttime);\n  // console.log(new Date(endtime).getTime());\n  let timeinterval = starttime + \",\" + new Date(endtime).getTime().toString();\n  // console.log(timeinterval)\n  modisLayer.getSource().updateParams({ TIME: timeinterval });\n  // Reset click value field\n  document.querySelector(\"#click-result\").innerHTML = \"Click on the map...\";\n};\n\nslider.noUiSlider.on('update', function (values, handle) {\n  var month_number = parseInt(values[handle]) + 1;\n  month.innerHTML = range[parseInt(values[handle])] + \", \" + document.querySelector(\"#modis_year\").value;\n  var timestampvalue = timestampStr(document.querySelector(\"#modis_year\").value + \",\" + month_number.toString() + \",01\");\n  // timestamp.innerHTML = \"Timestamp: \"+timestampvalue;\n  updateTimeFilter(timestampvalue);\n});\n\n// Change MODIS PRODUCT\n// ********************\nconst selectModis = document.querySelector('#modis_product');\n\nselectModis.addEventListener('change', event => {\n  let product = event.target.value;\n  if (product == 'LSTD') {\n    modisLayer.getSource().setUrl(lstd_url);\n  } else if (product == 'LSTN') {\n    modisLayer.getSource().setUrl(lstn_url);\n  } else if (product == 'NDVI') {\n    modisLayer.getSource().setUrl(ndvi_url);\n  } else {\n    modisLayer.getSource().setUrl(evi_url);\n  }\n});\n\n// Change MODIS YEAR\n// ********************\nconst selectYear = document.querySelector('#modis_year');\n\nselectYear.addEventListener('change', event => {\n  let year = event.target.value;\n  let value = slider.noUiSlider.get();\n  let startMonth = parseInt(value);\n  let endMonth = startMonth + 1;\n  let start = new Date(year, parseInt(startMonth).toString(), '01').getTime();\n  let end = new Date(year, parseInt(endMonth).toString(), '01').getTime();\n  console.log(start + \",\" + end);\n  updateTimeFilter(start + \",\" + end);\n  month.innerHTML = range[parseInt(value)] + \", \" + year;\n});\n\n// Request MODIS VALUES\n// ********************\nconst requestModisValues = function (coordinates) {\n  // Transform coordinates from 3857 to 4326\n  const coords = (0, _proj.transform)(coordinates, 'EPSG:3857', 'EPSG:4326');\n  let lng = coords[0];\n  let lat = coords[1];\n  // Read selection\n  let url = modisLayer.getSource().getUrl();\n  let modis_params = modisLayer.getSource().getParams();\n  let modis_time_arr = modis_params.TIME.split(\",\");\n  let modis_samples_date = (0, _moment2.default)(parseInt(modis_time_arr[0])).format(\"DD/MM/YYYY\");\n  // console.log(modis_samples_date);\n\n  // Get Samples from Image Service\n  _axios2.default.get(url + '/getSamples', {\n    params: {\n      geometry: '{\"x\":' + lng + ',\"y\":' + lat + '}',\n      geometryType: 'esriGeometryPoint',\n      spatialReference: '{\"wkid\":4326}',\n      mosaicRule: {\n        mosaicMethod: \"esriMosaicAttributes\",\n        // where: \"Timeref >= DATE '01/01/2019' AND Timeref <= DATE '01/03/2019'\",\n        where: \"Timeref = DATE '\" + modis_samples_date + \"'\",\n        sortField: \"Timeref\"\n      },\n      outFields: 'Name, Timeref',\n      returnFirstValueOnly: 'false',\n      f: 'json'\n    }\n  }).then(function (response) {\n    let samples = response.data;\n    parseModisValues(samples);\n  });\n};\n\nconst parseModisValues = function (samples) {\n  let pixel_value = samples.samples[0].value;\n  let source_url = modisLayer.getSource().getUrl();\n  if (source_url.includes('LSTD') || source_url.includes('LSTN')) {\n    // Normalize temperature values\n    pixel_value = pixel_value * 0.02 - 273.15;\n    document.querySelector(\"#click-result\").innerHTML = \"Temp. \" + pixel_value.toFixed(2) + \"Â°C\";\n  } else {\n    // Normalize vegetation index values\n    pixel_value = pixel_value * 0.0001;\n    document.querySelector(\"#click-result\").innerHTML = \"Veg. Index \" + pixel_value.toFixed(3);\n  }\n  // console.log(pixel_value);\n};"},"hash":"9d6c48a9faf303ec8a3ab5da27084f68"}